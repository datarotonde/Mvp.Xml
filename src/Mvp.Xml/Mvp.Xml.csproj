<Project Sdk="Microsoft.NET.Sdk" InitialTargets="SetupProperties">

    <PropertyGroup>
        <TargetFramework>netstandard2.0</TargetFramework>
        <EnableRexCodeGenerator>true</EnableRexCodeGenerator>
        <PackageTags>xml;xslt;exslt;xinclude;xpointer;xmlbase</PackageTags>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="System.CodeDom" Version="6.0.0" />
        <PackageReference Include="System.Security.Permissions" Version="6.0.0" />
        <PackageReference Include="System.Xml.XmlDocument" Version="4.3.0" />
        <PackageReference Include="Microsoft.NETCore.ILAsm" Version="6.0.0" GeneratePathProperty="true" />
        <PackageReference Include="Microsoft.NETCore.ILDAsm" Version="6.0.0" GeneratePathProperty="true" />
    </ItemGroup>

    <ItemGroup>
      <ProjectReference Include="..\MethodRenamer\MethodRenamer.csproj" 
                        ReferenceOutputAssembly="false"
                        OutputItemType="None"
                        SkipGetTargetFrameworkProperties="true" />
    </ItemGroup>

    <ItemGroup>
      <Compile Update="Properties\Resources.Designer.cs">
        <DesignTime>True</DesignTime>
        <AutoGen>True</AutoGen>
        <DependentUpon>Resources.resx</DependentUpon>
      </Compile>
    </ItemGroup>

    <ItemGroup>
      <EmbeddedResource Update="Properties\Resources.resx">
        <Generator>ResXFileCodeGenerator</Generator>
        <LastGenOutput>Resources.Designer.cs</LastGenOutput>
      </EmbeddedResource>
    </ItemGroup>

    <Target Name="SetupProperties">
        <PropertyGroup>
            <TargetIlPath>$(MSBuildProjectDirectory)\$(IntermediateOutputPath)$(TargetName).il</TargetIlPath>
            <FixedIlPath>$(MSBuildProjectDirectory)\$(IntermediateOutputPath)$(TargetName).fixed.il</FixedIlPath>
            <IlWorkingDirectory>$(MSBuildProjectDirectory)\$(IntermediateOutputPath)</IlWorkingDirectory>
        </PropertyGroup>
    </Target>

    <Target Name="RenameMethods" AfterTargets="CoreCompile" Inputs="@(IntermediateAssembly)" Outputs="$(TargetIlPath);$(FixedIlPath)">
        <PropertyGroup>
            <IntermediateAssembly>@(IntermediateAssembly -> '%(FullPath)')</IntermediateAssembly>
        </PropertyGroup>
        <Exec Command='$(PkgMicrosoft_NETCore_ILDAsm)\runtimes\native\ildasm.exe "$(IntermediateAssembly)" /out="$(TargetIlPath)" /linenum' WorkingDirectory='$(IlWorkingDirectory)' />
        <Exec Command='dotnet $(MSBuildProjectDirectory)\..\MethodRenamer\bin\$(Configuration)\MethodRenamer.dll RenameMappings.json "$(TargetIlPath)" "$(FixedIlPath)"' />
        <Exec Command='$(PkgMicrosoft_NETCore_ILAsm)\runtimes\native\ilasm.exe "$(FixedIlPath)" /output="$(IntermediateAssembly)" /dll /pdb' WorkingDirectory='$(IlWorkingDirectory)' />
    </Target>

</Project>
